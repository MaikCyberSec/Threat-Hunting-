ðŸ¦Š Foxveil Malware â€“ Detection & Hunting (Microsoft Defender KQL)

Overview
Foxveil is a recently identified malware loader that leverages trusted cloud infrastructure (e.g., Cloudflare Pages, Netlify, Discord-hosted content) to stage and retrieve second-phase payloads.
The malware focuses on:
Cloud-hosted payload staging
In-memory execution
Process masquerading (svchost-like behavior)
Service-based persistence
SysWOW64 payload drops

Microsoft Defender tampering / exclusion attempts
Because Foxveil abuses legitimate infrastructure, traditional domain blocking alone is insufficient. Detection must rely on behavioral correlation across network, process, file, and persistence telemetry.

ðŸŽ¯ Detection Strategy
This repository provides a working Microsoft Defender Advanced Hunting KQL query that:
Identifies suspicious staging activity from cloud-hosted domains
Detects abnormal svchost execution patterns
Monitors SysWOW64 payload drops
Flags suspicious service creation
Detects Microsoft Defender tampering attempts
Correlates events within a defined time window

##KQL Defender Detection##


let Lookback = 14d;
let CorrelationWindow = 60m;

// Known Foxveil staging domains (as listed in the article)
let KnownDomains = dynamic([
  "syscore.pages.dev",
  "taskhostw.pages.dev",
  "smss-416.pages.dev",
  "csrss.netlify.app",
  "sec-healthcore.netlify.app",
  "smss1.netlify.app",
  "driverstore-cdn.netlify.aap",
  "latestumang.netlify.app",
  "winsysops.netlify.app",
  "sihost.netlify.app",
  "premiumitems.netlify.app"
]);

let WindowsLikeStems = dynamic([
  "svchost","taskhostw","smss","csrss","sihost","conhost","lsass","winlogon","services","dllhost","rundll32","wmiprvse","spoolsv","explorer"
]);

// 1) Network staging signals (using RemoteUrl, extract domain)
let StagingNet =
DeviceNetworkEvents
| where Timestamp >= ago(Lookback)
| where isnotempty(RemoteUrl)
| extend Url = tolower(RemoteUrl)
| extend Domain = extract(@"https?://([^/:]+)", 1, Url)
| extend HostStem = tostring(split(Domain, ".")[0])
| extend IsWindowsLikeStem = HostStem has_any (WindowsLikeStems)
| where
    Domain has_any (KnownDomains)
    or Domain endswith ".pages.dev"
    or Domain endswith ".netlify.app"
    or Url has "discord"
| project
    DeviceId, DeviceName, NetTime=Timestamp,
    InitiatingProcessAccountName,
    InitiatingProcessFileName, InitiatingProcessCommandLine, InitiatingProcessFolderPath,
    Domain, Url, RemoteIP, IsWindowsLikeStem;

// 2) SysWOW64 drops
let Syswow64Drops =
DeviceFileEvents
| where Timestamp >= ago(Lookback)
| where ActionType in ("FileCreated","FileRenamed","FileModified")
| where FolderPath has @"\Windows\SysWOW64\"
| project
    DeviceId, DropTime=Timestamp,
    DroppedFileName=FileName, DroppedFolderPath=FolderPath, DroppedSHA256=SHA256,
    DropInitiatingProcess=InitiatingProcessFileName,
    DropInitiatingCmd=InitiatingProcessCommandLine,
    DropInitiatingPath=InitiatingProcessFolderPath;

// 3) Suspicious svchost execution (no parent commandline field)
let SuspiciousSvchost =
DeviceProcessEvents
| where Timestamp >= ago(Lookback)
| where FileName =~ "svchost.exe"
| extend PathLower = tolower(FolderPath), ParentLower = tolower(InitiatingProcessParentFileName)
| where
    (PathLower !has @"\windows\system32\" and PathLower !has @"\windows\syswow64\")
    or (ParentLower !in ("services.exe","wininit.exe"))
| project
    DeviceId, SvchostTime=Timestamp,
    SvchostPath=FolderPath,
    SvchostCmd=ProcessCommandLine,
    SvchostParent=InitiatingProcessParentFileName;

// 4) Service persistence events
let ServiceInstalls =
DeviceEvents
| where Timestamp >= ago(Lookback)
| where ActionType in ("ServiceInstalled","ServiceCreated","ServiceModified")
| project
    DeviceId, ServiceTime=Timestamp,
    ServiceActionType=ActionType,
    ServiceDetails=AdditionalFields;

// 5) Defender tampering / exclusions
let DefenderTamper =
union
(
  DeviceProcessEvents
  | where Timestamp >= ago(Lookback)
  | where tolower(ProcessCommandLine) has_any ("add-mppreference","set-mppreference","mpcmdrun","exclusion","disablerealtimemonitoring")
  | project DeviceId, DefTime=Timestamp, DefSignal="DefenderProcess", DefCmd=ProcessCommandLine
),
(
  DeviceRegistryEvents
  | where Timestamp >= ago(Lookback)
  | where tolower(RegistryKey) has_any ("windows defender","microsoft\\windows defender","exclusions","policies\\microsoft\\windows defender")
  | project DeviceId, DefTime=Timestamp, DefSignal="DefenderRegistry",
           DefCmd=strcat("REG:", RegistryKey, " | ", RegistryValueName, "=", tostring(RegistryValueData))
);

// Correlate staging network activity with endpoint behaviors
StagingNet
| join kind=leftouter Syswow64Drops on DeviceId
| where isnull(DropTime) or DropTime between (NetTime .. NetTime + CorrelationWindow)
| join kind=leftouter SuspiciousSvchost on DeviceId
| where isnull(SvchostTime) or SvchostTime between (NetTime .. NetTime + CorrelationWindow)
| join kind=leftouter ServiceInstalls on DeviceId
| where isnull(ServiceTime) or ServiceTime between (NetTime .. NetTime + CorrelationWindow)
| join kind=leftouter DefenderTamper on DeviceId
| where isnull(DefTime) or DefTime between (NetTime .. NetTime + CorrelationWindow)
| extend SuspicionScore =
    1
    + iff(IsWindowsLikeStem, 1, 0)
    + iff(isnotnull(DropTime), 2, 0)
    + iff(isnotnull(SvchostTime), 2, 0)
    + iff(isnotnull(ServiceTime), 2, 0)
    + iff(isnotnull(DefTime), 2, 0)
| project
    DeviceName, DeviceId,
    NetTime, Domain, Url, RemoteIP,
    InitiatingProcessFileName, InitiatingProcessFolderPath, InitiatingProcessCommandLine,
    DropTime, DroppedFileName, DroppedFolderPath, DroppedSHA256,
    SvchostTime, SvchostPath, SvchostCmd, SvchostParent,
    ServiceTime, ServiceActionType, ServiceDetails,
    DefTime, DefSignal, DefCmd,
    SuspicionScore
| order by SuspicionScore desc, NetTime desc
