FoxKitsune Malware Activity Detection
This rule detects various activities associated with the FoxKitsune malware, including network staging, suspicious file drops in SysWOW64, unusual svchost execution, service persistence, and attempts to tamper with Windows Defender. It correlates these events to identify potential FoxKitsune infections.
Cato CTRL identified a newly observed malware loader named Foxveil, active since August 2025. Foxveil operates as an initial-stage loader designed to establish persistence, evade analysis, and retrieve additional payloads from trusted cloud-hosted infrastructure.
The malware leverages legitimate platforms such as Cloudflare Pages, Netlify, and Discord-hosted content to stage second-phase payloads. This technique enables it to blend into normal outbound traffic and evade traditional domain-based blocking controls.
Two variants (v1 and v2) were observed. Both focus on stealth execution, process injection, and persistence mechanisms. Variant differences include injection methods and defensive evasion tactics such as attempted Microsoft Defender configuration manipulation.
Foxveil represents a modern loader threat that relies heavily on trusted infrastructure abuse, in-memory execution, and defense evasion rather than noisy exploitation techniques.

let Lookback = 14d;
let CorrelationWindow = 60m;

// Known Foxveil staging domains (as listed in the article)
let KnownDomains = dynamic([
  "syscore.pages.dev",
  "taskhostw.pages.dev",
  "smss-416.pages.dev",
  "csrss.netlify.app",
  "sec-healthcore.netlify.app",
  "smss1.netlify.app",
  "driverstore-cdn.netlify.aap",
  "latestumang.netlify.app",
  "winsysops.netlify.app",
  "sihost.netlify.app",
  "premiumitems.netlify.app"
]);

let WindowsLikeStems = dynamic([
  "svchost","taskhostw","smss","csrss","sihost","conhost","lsass","winlogon","services","dllhost","rundll32","wmiprvse","spoolsv","explorer"
]);

// 1) Network staging signals (using RemoteUrl, extract domain)
let StagingNet =
DeviceNetworkEvents
| where Timestamp >= ago(Lookback)
| where isnotempty(RemoteUrl)
| extend Url = tolower(RemoteUrl)
| extend Domain = extract(@"https?://([^/:]+)", 1, Url)
| extend HostStem = tostring(split(Domain, ".")[0])
| extend IsWindowsLikeStem = HostStem has_any (WindowsLikeStems)
| where
    Domain has_any (KnownDomains)
    or Domain endswith ".pages.dev"
    or Domain endswith ".netlify.app"
    or Url has "discord"
| project
    DeviceId, DeviceName, NetTime=Timestamp,
    InitiatingProcessAccountName,
    InitiatingProcessFileName, InitiatingProcessCommandLine, InitiatingProcessFolderPath,
    Domain, Url, RemoteIP, IsWindowsLikeStem;

// 2) SysWOW64 drops
let Syswow64Drops =
DeviceFileEvents
| where Timestamp >= ago(Lookback)
| where ActionType in ("FileCreated","FileRenamed","FileModified")
| where FolderPath has @"\Windows\SysWOW64\"
| project
    DeviceId, DropTime=Timestamp,
    DroppedFileName=FileName, DroppedFolderPath=FolderPath, DroppedSHA256=SHA256,
    DropInitiatingProcess=InitiatingProcessFileName,
    DropInitiatingCmd=InitiatingProcessCommandLine,
    DropInitiatingPath=InitiatingProcessFolderPath;

// 3) Suspicious svchost execution (no parent commandline field)
let SuspiciousSvchost =
DeviceProcessEvents
| where Timestamp >= ago(Lookback)
| where FileName =~ "svchost.exe"
| extend PathLower = tolower(FolderPath), ParentLower = tolower(InitiatingProcessParentFileName)
| where
    (PathLower !has @"\windows\system32\" and PathLower !has @"\windows\syswow64\")
    or (ParentLower !in ("services.exe","wininit.exe"))
| project
    DeviceId, SvchostTime=Timestamp,
    SvchostPath=FolderPath,
    SvchostCmd=ProcessCommandLine,
    SvchostParent=InitiatingProcessParentFileName;

// 4) Service persistence events
let ServiceInstalls =
DeviceEvents
| where Timestamp >= ago(Lookback)
| where ActionType in ("ServiceInstalled","ServiceCreated","ServiceModified")
| project
    DeviceId, ServiceTime=Timestamp,
    ServiceActionType=ActionType,
    ServiceDetails=AdditionalFields;

// 5) Defender tampering / exclusions
let DefenderTamper =
union
(
  DeviceProcessEvents
  | where Timestamp >= ago(Lookback)
  | where tolower(ProcessCommandLine) has_any ("add-mppreference","set-mppreference","mpcmdrun","exclusion","disablerealtimemonitoring")
  | project DeviceId, DefTime=Timestamp, DefSignal="DefenderProcess", DefCmd=ProcessCommandLine
),
(
  DeviceRegistryEvents
  | where Timestamp >= ago(Lookback)
  | where tolower(RegistryKey) has_any ("windows defender","microsoft\\windows defender","exclusions","policies\\microsoft\\windows defender")
  | project DeviceId, DefTime=Timestamp, DefSignal="DefenderRegistry",
           DefCmd=strcat("REG:", RegistryKey, " | ", RegistryValueName, "=", tostring(RegistryValueData))
);

// Correlate staging network activity with endpoint behaviors
StagingNet
| join kind=leftouter Syswow64Drops on DeviceId
| where isnull(DropTime) or DropTime between (NetTime .. NetTime + CorrelationWindow)
| join kind=leftouter SuspiciousSvchost on DeviceId
| where isnull(SvchostTime) or SvchostTime between (NetTime .. NetTime + CorrelationWindow)
| join kind=leftouter ServiceInstalls on DeviceId
| where isnull(ServiceTime) or ServiceTime between (NetTime .. NetTime + CorrelationWindow)
| join kind=leftouter DefenderTamper on DeviceId
| where isnull(DefTime) or DefTime between (NetTime .. NetTime + CorrelationWindow)
| extend SuspicionScore =
    1
    + iff(IsWindowsLikeStem, 1, 0)
    + iff(isnotnull(DropTime), 2, 0)
    + iff(isnotnull(SvchostTime), 2, 0)
    + iff(isnotnull(ServiceTime), 2, 0)
    + iff(isnotnull(DefTime), 2, 0)
| project
    DeviceName, DeviceId,
    NetTime, Domain, Url, RemoteIP,
    InitiatingProcessFileName, InitiatingProcessFolderPath, InitiatingProcessCommandLine,
    DropTime, DroppedFileName, DroppedFolderPath, DroppedSHA256,
    SvchostTime, SvchostPath, SvchostCmd, SvchostParent,
    ServiceTime, ServiceActionType, ServiceDetails,
    DefTime, DefSignal, DefCmd,
    SuspicionScore
| order by SuspicionScore desc, NetTime desc
